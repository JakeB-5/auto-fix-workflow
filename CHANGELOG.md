# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

## [0.4.12] - 2026-02-05

### Changed

- **Dry-run with real AI analysis**: `triage --dry-run` now performs actual AI analysis
  - Shows analysis results (type, priority, component, confidence, related files)
  - Still skips side effects (no GitHub issues created, no Asana updates)
  - Useful for verifying AI analysis without making changes

## [0.4.11] - 2026-02-05

### Fixed

- **allowedTools format**: Fix `--allowedTools` CLI argument to use comma-separated format
  - Changed from `--allowedTools Read Glob Grep` to `--allowedTools Read,Glob,Grep`
  - Ensures Claude CLI correctly enables code analysis tools

## [0.4.10] - 2026-02-05

### Fixed

- **Triage Code Analysis**: Fixed triage command to actually analyze source code in working directory
  - Added `allowedTools: ['Read', 'Glob', 'Grep']` to enable Claude to read files
  - Added `workingDir: process.cwd()` to set correct working directory
  - Updated prompt to instruct Claude to explore codebase before analysis
  - Now produces accurate component names, related files, and higher confidence scores

## [0.4.9] - 2026-02-04

### Fixed

- **Claude CLI spawn EINVAL (v2)**: Fixed Windows spawn error when invoking Claude CLI
  - Use `shell: true` with command as single string (empty args array)
  - Pipe prompt through stdin instead of command-line argument
  - Resolves `spawn EINVAL` error caused by special characters in Korean text
  - Avoids DEP0190 warning (shell: true with args)

## [0.4.8] - 2026-02-04

### Fixed

- **Claude CLI spawn EINVAL**: Attempted fix (incomplete - stdin with `-` not supported)

### Improved

- **GitHub Issue Body Format**: Aligned generated issue body with `.github/ISSUE_TEMPLATE/auto-fix-issue.yml` format
  - Added structured sections: Type, Source, Context, Problem Description, Code Analysis, Acceptance Criteria
  - Type section includes emoji prefix matching template options

## [0.4.7] - 2026-02-04

### Fixed

- **Section Filtering**: Fixed triage command processing all tasks instead of only "To Triage" section
  - `listTasks` now accepts `sectionGid` directly (not just `sectionName`)
  - `AsanaDirectAdapter` passes section GID correctly to filter tasks by section

### Improved

- **Real-time Claude Output**: Claude CLI now uses `stream-json` format for real-time output visibility
  - Shows Claude's thinking and responses as they stream
  - Helps users see progress during long-running AI analysis

## [0.4.6] - 2026-02-04

### Fixed

- **Node.js DEP0190 Warning**: Resolved deprecation warning when invoking Claude CLI
  - Changed from `shell: true` to `shell: false` with explicit `.cmd` extension on Windows
  - Eliminates "Passing args to a child process with shell option true can lead to security vulnerabilities" warning

### Note

- **npm deprecated warnings**: Warnings about `inflight`, `glob`, `formidable`, `superagent` are from the `asana@3.0.0` package dependencies and cannot be fixed directly. Waiting for Asana SDK update.

## [0.4.5] - 2026-02-04

### Fixed

- **AI Model Selection**: Use `opus` as default model per spec REQ-AI-002 (was incorrectly using `haiku`)
- **Analysis Timeout**: Use 5 minute timeout per spec REQ-AI-005 (was 30 seconds)

### Improved

- **CLI Progress Output**: Show progress for each task (`[1/5] Processing: ...`)
  - Display task analysis status
  - Show GitHub issue creation progress
  - Show Asana update status
  - Helps identify if process is running or stuck

## [0.4.4] - 2026-02-04

### Fixed

- **AI Response Parsing**: Fixed parsing of Claude CLI JSON-wrapped output
  - Properly extracts `result` field from `--output-format json` output
  - Handles JSON embedded in markdown code blocks
  - Falls back to heuristic analysis only when actual parsing fails

## [0.4.3] - 2026-02-04

### Fixed

- **Triage Tag Handling**: Fixed `Cannot read properties of undefined (reading 'toLowerCase')` error when task tags have undefined names
- **Synced Tag Addition**: Now properly adds "synced" tag to Asana tasks after creating GitHub issues
- **Null-safe Tag Mapping**: Tag names are now defaulted to empty string when undefined in Asana API responses

### Added

- **findTagByName API**: Added `findTagByName` method to AsanaToolset for looking up tag GIDs by name

## [0.4.2] - 2026-02-04

### Fixed

- **Triage Config Compatibility**: Fixed triage command to read from standard `.auto-fix.yaml` format generated by `init` command
  - Now reads `asana.sections.triage` for triage section name (default: "To Triage")
  - Now reads `asana.sections.triaged` for processed section name
  - Now reads `asana.tags.triaged` for synced tag name
  - Now reads `asana.projectId` for default project GID
  - Maintains backward compatibility with legacy format

## [0.4.1] - 2026-02-04

### Fixed

- **ES Module Compatibility**: Fixed `require is not defined` error in triage CLI by using dynamic `import()` instead of `require()` for ES module compatibility

## [0.4.0] - 2026-02-04

### Added

- **CLI Standalone Mode**: Run `triage` and `autofix` commands without MCP client
  - `npx auto-fix-workflow autofix` - Direct CLI execution with all existing options
  - `npx auto-fix-workflow triage` - Full standalone triage implementation
  - New `--help` output for both commands with usage examples
- **TriageToolset Abstraction**: Unified interface for MCP and Direct API modes
  - `TriageToolset` interface with `AsanaToolset`, `GitHubToolset`, `AnalyzerToolset`
  - Factory pattern (`createToolset()`) for mode-based toolset creation
  - Seamless switching between MCP client mode and standalone CLI mode
- **Direct API Adapters**: Native API wrappers for standalone execution
  - `AsanaDirectAdapter`: Wraps existing Asana API modules
  - `GitHubDirectAdapter`: Wraps existing GitHub API modules
  - `AnalyzerDirectAdapter`: Uses `AIIntegration` for task analysis
- **AI Task Analysis**: `analyzeAsanaTask()` method in `AIIntegration` class
  - Claude CLI-based analysis with structured JSON output
  - Heuristic fallback when Claude CLI is unavailable
  - Issue type, priority, component, and acceptance criteria extraction
- **MCP Asana getTask**: Added `getTask()` method to `AsanaListTool` for MCP mode compatibility

### Fixed

- **GitHub Token Config**: `github_create_issue` MCP tool now properly reads GitHub token from `.auto-fix.yaml` configuration file (#10)
  - Supports both `tokens.github` and `github.token` formats
  - Falls back to `GITHUB_TOKEN` environment variable for backwards compatibility
  - Improved error message to guide users on both configuration methods

### Documentation

- **SDD Specifications**: Added `cli/standalone-commands/` spec with plan and tasks
  - Detailed implementation plan with 6 phases
  - 11 task items with dependency graph

## [0.3.6] - 2026-02-03

### Fixed

- **Asana npm v3 API Migration**: Updated client wrapper to work with `asana@3.0.0` (#5)
  - Migrated from deprecated `Asana.Client.create()` (v1) to `Asana.ApiClient.instance` + individual API classes (v3)
  - Created wrapper interface (`AsanaClientWrapper`) for consistent API access
  - Updated all Asana modules to use new response structure (`{ data: ... }`)
  - Fixed TypeScript compatibility with typeless v3 SDK

## [0.3.5] - 2026-02-03

### Fixed

- **Worktree Config Schema**: Normalize user-friendly field names to schema-expected names (#4)
  - `worktree.basePath` → `worktree.baseDir`
  - `worktree.maxParallel` → `worktree.maxConcurrent`

### Improved

- **Config Error Diagnostics**: Enhanced Asana tool error responses to include actual config loading error, current working directory, and AUTO_FIX_CONFIG env var status for better debugging

## [0.3.4] - 2026-02-03

### Fixed

- **Asana Config Schema**: Normalize user-friendly field names to schema-expected names (#3)
  - `tokens.asana` → `asana.token`
  - `asana.workspaceId` → `asana.workspaceGid`
  - `asana.projectId` (string) → `asana.projectGids` (array)

## [0.3.3] - 2026-02-03

### Added

- **AUTO_FIX_CONFIG Environment Variable**: Support for specifying config file path via `AUTO_FIX_CONFIG` env var, solving MCP server cwd issues (#2)

### Improved

- **Error Messages**: Config not found errors now include current working directory and AUTO_FIX_CONFIG hint for easier debugging

## [0.3.2] - 2026-02-03

### Fixed

- **Asana Error Message**: Corrected config filename from `.autofix-workflow.json` to `.auto-fix.yaml` in error messages (#1)

## [0.3.1] - 2026-02-03

### Fixed

- **CLI Entry Point**: Added shebang (`#!/usr/bin/env node`) to `src/index.ts` to fix `npx auto-fix-workflow init` not executing on Windows (file was opening in editor instead of running)

## [0.3.0] - 2026-02-03

### Added

- **AI Integration Module** (`ai-integration.ts`)
  - `invokeClaudeCLI()` function for spawning Claude CLI processes
  - `safeInvokeClaude()` with exponential backoff retry logic for rate limits
  - `analyzeGroup()` and `applyFix()` methods for issue processing
  - 10 error codes for precise error handling (CLI_NOT_FOUND, TIMEOUT, RATE_LIMIT, BUDGET_EXCEEDED, etc.)
- **Budget Tracking Module** (`budget.ts`)
  - `BudgetTracker` class for cost management
  - Per-issue and per-session cost tracking
  - Dynamic model fallback based on budget utilization (<80% opus, 80-90% sonnet, >90% haiku)
  - `canSpend()`, `addCost()`, `getCurrentModel()`, `resetIssue()` methods
- **Prompt Templates Module** (`prompts.ts`)
  - `ANALYSIS_PROMPT_TEMPLATE`, `FIX_PROMPT_TEMPLATE`, `RETRY_PROMPT_TEMPLATE`
  - `renderTemplate()` function with Handlebars-like syntax
  - JSON schemas for structured AI output validation
- **Init Command Enhancements**
  - Auto-generate GitHub Issue Template (`.github/ISSUE_TEMPLATE/auto-fix-issue.yml`)
  - Auto-generate PR Template (`.github/PULL_REQUEST_TEMPLATE.md`)
  - Auto-create `autofixing` branch with push to origin
  - New generators: `issue-template.ts`, `pr-template.ts`, `github-labels.ts`, `branch.ts`
- **Test Suites**
  - Comprehensive test coverage for AI integration modules (1,764 lines of tests)
  - Unit tests for budget tracking, prompt rendering, and CLI integration

### Changed

- **AIAnalysisResult Type** (Breaking Change)
  - Replaced `approach` field with `rootCause` and `suggestedFix` for better structure
- **AIIntegration.canHandle()**
  - Now performs actual validation (budget + complexity + file count) instead of placeholder logic

### Documentation

- Added SDD specifications for ai-integration, budget, and prompts domains
- Updated `domains.yml` with autofix domain definitions

## [0.2.0] - 2026-01-30

### Added

- **Init Command** (`npx auto-fix-workflow init`)
  - Interactive token input for GitHub and Asana
  - Automatic `.mcp.json` generation (MCP server config)
  - Automatic `.auto-fix.yaml` generation with tokens
  - Automatic `.gitignore` update for security
  - Token validation (online API check + offline format check)
  - Non-interactive mode for CI/CD (`--non-interactive`)
  - Force overwrite option (`--force`)
  - Skip validation option (`--skip-validation`)

## [0.1.1] - 2026-01-30

### Added

- **Documentation**
  - Setup guide for GitHub, Asana, Sentry integration (`docs/SETUP.md`)
  - Korean documentation (`README.ko.md`, `docs/SETUP.ko.md`)
  - Workflow examples in README (triage, autofix, dry-run)
  - API token scopes documentation

- **SDD Specifications**
  - Added `.sdd/` specs for all modules
  - Domain definitions and constitution
  - Spec templates for future development

### Changed

- Synced spec documentation with implementation
  - `task-analyzer`: confidence type (string → number)
  - `triage`: CLI parameters aligned with implementation

### Fixed

- SDD validation workflow compatibility

---

## [0.1.0] - 2026-01-30

### Added

- **MCP Server**: Model Context Protocol server with tool registration
- **GitHub Integration**
  - `github_get_issue`: Fetch issue details
  - `github_list_issues`: List and filter issues
  - `github_create_issue`: Create issues with labels
  - `github_update_issue`: Update issue state/content
  - `github_create_pr`: Create pull requests
- **Asana Integration**
  - `asana_get_task`: Fetch task details
  - `asana_list_tasks`: List project tasks
  - `asana_update_task`: Update task status
  - `asana_analyze_task`: Analyze for auto-fix suitability
- **Git Worktree Management**
  - Create isolated worktrees for parallel development
  - Automatic cleanup on success/failure
  - Branch name generation
- **Code Quality Checks**
  - Run typecheck, lint, test in configurable order
  - Package manager auto-detection (npm/yarn/pnpm)
  - Timeout handling with process cleanup
  - Fail-fast mode support
- **Analyzer Tools**
  - Task classification (bug, feature, docs, chore)
  - Complexity estimation
  - Code location mapping
  - Issue generation from analysis
- **Workflow Orchestration**
  - Issue grouping by component/file
  - Fix strategy planning
  - Batch processing support
- **Commands**
  - `triage`: Prioritize and categorize issues
  - `autofix`: Execute full auto-fix workflow
  - Dry-run mode for previewing operations
- **Configuration**
  - YAML configuration file support
  - Environment variable overrides
  - Schema validation with Zod
- **Logging**
  - Structured logging with Pino
  - Sensitive data masking
  - Multiple log levels

### Infrastructure

- TypeScript with strict mode
- Vitest test framework (993+ tests)
- ESLint for code quality
- GitHub Actions CI/CD
- Automated npm publishing
- GitHub release automation

[0.4.12]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.11...v0.4.12
[0.4.11]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.10...v0.4.11
[0.4.10]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.9...v0.4.10
[0.4.9]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.8...v0.4.9
[0.4.8]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.7...v0.4.8
[0.4.7]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.6...v0.4.7
[0.4.6]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.5...v0.4.6
[0.4.5]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.4...v0.4.5
[0.4.4]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.3...v0.4.4
[0.4.3]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.2...v0.4.3
[0.4.2]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.1...v0.4.2
[0.4.1]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.4.0...v0.4.1
[0.4.0]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.3.7...v0.4.0
[0.1.1]: https://github.com/JakeB-5/auto-fix-workflow/compare/v0.1.0...v0.1.1
[0.1.0]: https://github.com/JakeB-5/auto-fix-workflow/releases/tag/v0.1.0
